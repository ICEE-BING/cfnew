name: Sync from Upstream Repository

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write permission to push changes
      actions: read    # Need read permission for workflow dispatch
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/byJoey/cfnew.git || true
          git remote -v
      
      - name: Fetch upstream changes
        run: |
          git fetch upstream
          echo "Fetched latest changes from upstream repository"
      
      - name: Get current branch
        id: get_branch
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          echo "Current branch: $CURRENT_BRANCH"
      
      - name: Check for changes
        id: check_changes
        run: |
          # Compare current branch with upstream main/master
          UPSTREAM_BRANCH="main"
          if git ls-remote --exit-code --heads upstream master >/dev/null 2>&1; then
            UPSTREAM_BRANCH="master"
          fi
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          
          CURRENT_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/$UPSTREAM_BRANCH)
          
          echo "Current commit: $CURRENT_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$CURRENT_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected, repository is up to date"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected from upstream"
          fi
      
      - name: Merge upstream changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          UPSTREAM_BRANCH="${{ steps.check_changes.outputs.upstream_branch }}"
          echo "Attempting to merge from upstream/$UPSTREAM_BRANCH"
          
          # Try to merge with strategy to prefer upstream changes for conflicts
          if git merge upstream/$UPSTREAM_BRANCH --no-edit -X theirs; then
            echo "Successfully merged upstream changes"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "Merge conflict detected"
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            
            # Check if there are conflicts
            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "Files with conflicts:"
              git diff --name-only --diff-filter=U
              
              # Abort the merge
              git merge --abort
              
              echo "⚠️ Merge conflicts detected. Manual intervention required." >> $GITHUB_STEP_SUMMARY
              echo "Please resolve conflicts manually by running:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "git fetch upstream" >> $GITHUB_STEP_SUMMARY
              echo "git merge upstream/$UPSTREAM_BRANCH" >> $GITHUB_STEP_SUMMARY
              echo "# Resolve conflicts, then:" >> $GITHUB_STEP_SUMMARY
              echo "git add ." >> $GITHUB_STEP_SUMMARY
              echo "git commit" >> $GITHUB_STEP_SUMMARY
              echo "git push" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              
              exit 0  # Don't fail the workflow
            fi
          fi
        continue-on-error: true
      
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Check if there are changes to push
          if git diff --quiet HEAD origin/${{ steps.get_branch.outputs.branch }}; then
            echo "No changes to push"
          else
            echo "Pushing synchronized changes to origin"
            git push origin ${{ steps.get_branch.outputs.branch }}
            echo "✅ Successfully synchronized with upstream repository" >> $GITHUB_STEP_SUMMARY
            echo "- Upstream: byJoey/cfnew" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: ${{ steps.get_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "- Synchronized at: $(date -u)" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Report no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "ℹ️ No synchronization needed" >> $GITHUB_STEP_SUMMARY
          echo "Repository is already up to date with upstream" >> $GITHUB_STEP_SUMMARY
